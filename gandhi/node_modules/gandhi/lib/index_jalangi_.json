{"8":[12,23,12,44],"9":[1,20,1,27],"10":[36,22,36,53],"16":[52,17,52,47],"17":[1,28,1,32],"18":[41,27,41,52],"24":[41,13,41,53],"25":[1,20,1,33],"26":[42,32,42,57],"32":[55,13,55,55],"33":[1,20,1,33],"34":[44,31,44,63],"40":[82,35,82,79],"41":[1,20,1,33],"42":[44,31,44,75],"48":[82,24,82,32],"49":[2,26,2,38],"50":[48,43,48,75],"56":[88,13,88,52],"57":[2,26,2,45],"58":[48,43,48,87],"64":[103,79,103,104],"65":[2,26,2,45],"66":[51,49,51,81],"72":[109,24,109,49],"73":[2,26,2,45],"74":[51,49,51,93],"80":[109,56,109,88],"81":[3,1,3,13],"82":[52,17,52,35],"88":[108,13,108,29],"89":[3,1,3,14],"90":[52,17,52,47],"96":[113,13,113,53],"97":[4,10,4,17],"98":[55,27,55,54],"104":[113,13,113,53],"105":[4,18,4,22],"106":[59,68,59,86],"113":[4,10,4,23],"114":[62,14,62,32],"121":[4,10,4,23],"122":[66,13,68,25],"129":[4,10,4,23],"130":[66,13,68,25],"137":[5,9,5,16],"138":[69,13,69,74],"145":[5,17,5,25],"146":[69,13,69,83],"153":[5,9,5,26],"154":[69,13,69,90],"161":[5,9,5,26],"162":[69,13,69,90],"169":[5,9,5,26],"170":[71,32,71,51],"177":[6,9,6,16],"178":[71,32,71,58],"185":[6,17,6,20],"186":[70,13,72,25],"193":[6,9,6,21],"194":[70,13,72,25],"201":[6,9,6,21],"202":[74,107,74,122],"209":[6,9,6,21],"210":[74,107,74,132],"217":[7,13,7,20],"218":[74,16,74,138],"225":[7,21,7,30],"226":[74,16,74,151],"233":[7,13,7,31],"234":[73,18,75,25],"241":[7,13,7,31],"242":[82,53,82,79],"249":[7,13,7,31],"250":[87,20,87,49],"257":[8,15,8,22],"258":[88,37,88,52],"265":[8,23,8,32],"266":[88,13,88,52],"273":[8,15,8,33],"274":[89,21,89,50],"281":[8,15,8,33],"282":[89,21,89,57],"289":[8,15,8,33],"290":[99,33,99,60],"297":[9,18,9,25],"298":[103,18,103,31],"305":[9,26,9,39],"306":[103,35,103,64],"313":[9,18,9,40],"314":[103,18,103,65],"321":[9,18,9,40],"322":[103,18,103,75],"329":[9,18,9,40],"330":[103,18,103,105],"337":[10,1,10,7],"338":[103,18,103,114],"345":[11,18,11,25],"346":[105,43,105,65],"353":[11,18,11,34],"354":[106,31,106,49],"355":[11,18,11,32],"361":[11,18,11,34],"362":[108,13,108,29],"369":[11,18,11,34],"370":[109,56,109,73],"377":[12,23,12,29],"378":[109,56,109,88],"385":[12,23,12,34],"386":[113,13,113,26],"393":[12,23,12,44],"394":[113,30,113,53],"401":[12,47,12,54],"409":[12,55,12,67],"417":[12,47,12,68],"425":[12,85,12,91],"433":[12,85,12,96],"441":[12,85,12,106],"449":[12,47,12,107],"451":[12,47,12,84],"457":[14,20,14,28],"465":[14,29,14,33],"473":[14,35,14,39],"481":[14,20,14,40],"489":[14,20,14,40],"497":[14,13,14,41],"505":[13,19,15,10],"513":[13,19,15,10],"521":[13,19,15,10],"529":[13,19,15,10],"537":[13,19,15,10],"545":[12,110,16,6],"553":[12,23,16,6],"561":[12,23,16,6],"569":[18,13,18,20],"577":[18,21,18,40],"585":[18,13,18,41],"593":[18,42,18,48],"601":[18,42,18,51],"609":[18,53,18,59],"617":[18,53,18,64],"625":[18,53,18,68],"633":[18,70,18,76],"641":[18,70,18,81],"649":[18,70,18,85],"657":[18,87,18,93],"665":[18,87,18,98],"673":[18,87,18,106],"681":[18,13,18,107],"689":[19,20,19,25],"697":[19,26,19,32],"705":[19,26,19,38],"713":[19,16,19,39],"721":[20,15,20,16],"729":[21,13,21,14],"737":[21,24,21,28],"745":[21,30,21,36],"753":[21,30,21,41],"761":[21,30,21,50],"769":[21,13,21,51],"771":[21,13,21,23],"777":[21,13,21,52],"785":[22,20,22,31],"793":[22,41,22,45],"801":[22,47,22,55],"809":[22,20,22,56],"811":[22,20,22,40],"817":[22,20,22,56],"825":[22,13,22,57],"833":[20,24,23,10],"841":[20,24,23,10],"849":[20,24,23,10],"857":[20,24,23,10],"865":[20,24,23,10],"873":[20,15,23,11],"875":[20,15,20,23],"881":[24,18,24,20],"889":[25,20,25,22],"897":[26,21,26,23],"905":[27,25,27,27],"913":[28,18,28,20],"921":[17,21,29,6],"929":[17,21,29,6],"937":[17,21,29,6],"945":[30,5,30,14],"953":[30,30,30,37],"961":[30,38,30,47],"969":[30,30,30,48],"977":[30,51,30,60],"985":[30,51,30,66],"993":[30,50,30,67],"1001":[31,21,31,22],"1009":[32,21,32,24],"1017":[30,69,33,6],"1025":[30,25,33,7],"1033":[30,5,33,7],"1041":[30,5,33,8],"1049":[34,5,34,14],"1057":[34,22,34,29],"1065":[34,30,34,51],"1073":[34,22,34,52],"1081":[34,53,34,59],"1089":[34,61,34,70],"1097":[34,22,34,71],"1105":[34,5,34,71],"1113":[34,5,34,72],"1121":[36,9,36,11],"1129":[36,22,36,31],"1137":[36,34,36,53],"1145":[36,9,36,54],"1147":[36,9,36,21],"1153":[36,9,36,55],"1161":[37,7,38,6],"1169":[39,21,39,28],"1177":[39,29,39,44],"1185":[39,21,39,45],"1193":[39,21,39,45],"1201":[39,21,39,45],"1209":[40,5,40,11],"1217":[40,5,40,19],"1225":[41,13,41,15],"1233":[41,27,41,36],"1241":[41,39,41,52],"1249":[41,13,41,53],"1251":[41,13,41,26],"1257":[42,24,42,31],"1265":[42,32,42,41],"1273":[42,44,42,57],"1281":[42,24,42,58],"1289":[42,24,42,58],"1297":[42,24,42,58],"1305":[44,17,44,19],"1313":[44,31,44,40],"1321":[44,43,44,63],"1329":[44,66,44,70],"1337":[44,66,44,75],"1345":[44,17,44,76],"1347":[44,17,44,30],"1353":[44,17,44,77],"1361":[45,15,46,14],"1369":[48,17,48,19],"1377":[48,32,48,41],"1385":[48,43,48,52],"1393":[48,55,48,75],"1401":[48,78,48,82],"1409":[48,78,48,87],"1417":[48,89,48,94],"1425":[48,17,48,95],"1427":[48,17,48,31],"1433":[48,17,48,96],"1441":[49,15,50,14],"1449":[51,13,51,22],"1457":[51,13,51,35],"1465":[51,36,51,40],"1473":[51,36,51,45],"1481":[51,49,51,58],"1489":[51,61,51,81],"1497":[51,84,51,88],"1505":[51,84,51,93],"1513":[51,13,51,93],"1521":[51,13,51,94],"1529":[52,24,52,28],"1537":[52,24,52,35],"1545":[52,39,52,47],"1553":[53,17,53,26],"1561":[53,17,53,34],"1569":[53,40,53,44],"1577":[53,40,53,51],"1585":[53,17,53,52],"1587":[53,17,53,39],"1593":[53,17,53,53],"1601":[55,13,55,15],"1609":[55,27,55,36],"1617":[55,39,55,54],"1625":[55,13,55,55],"1627":[55,13,55,26],"1633":[56,13,56,20],"1641":[56,21,56,30],"1649":[56,13,56,31],"1657":[56,32,56,38],"1665":[56,40,56,49],"1673":[56,13,56,50],"1681":[56,13,56,51],"1689":[40,28,58,6],"1697":[40,28,58,6],"1705":[40,28,58,6],"1713":[40,28,58,6],"1721":[40,28,58,6],"1729":[40,5,58,7],"1731":[40,5,40,27],"1737":[40,5,58,8],"1745":[59,5,59,12],"1753":[59,13,59,20],"1761":[59,5,59,21],"1769":[59,5,59,30],"1777":[59,39,59,48],"1785":[59,50,59,59],"1793":[59,68,59,77],"1801":[59,80,59,86],"1809":[59,61,59,88],"1817":[59,5,59,89],"1819":[59,5,59,38],"1825":[59,5,59,90],"1833":[60,16,60,23],"1841":[60,24,60,33],"1849":[60,16,60,34],"1857":[61,20,61,29],"1865":[62,14,62,23],"1873":[62,26,62,32],"1881":[63,18,63,27],"1889":[63,18,63,35],"1897":[60,35,64,6],"1905":[60,16,64,7],"1913":[60,16,64,7],"1921":[60,16,64,7],"1929":[65,16,65,18],"1937":[65,16,65,18],"1945":[65,16,65,18],"1953":[66,13,66,17],"1961":[66,13,66,20],"1969":[67,16,67,18],"1977":[67,32,67,36],"1985":[67,16,67,37],"1987":[67,16,67,31],"1993":[67,16,67,37],"2001":[67,9,67,38],"2009":[66,25,68,6],"2017":[66,25,68,6],"2025":[66,25,68,6],"2033":[66,25,68,6],"2041":[66,13,68,7],"2043":[66,13,66,24],"2049":[68,13,68,17],"2057":[66,13,68,18],"2059":[66,13,68,12],"2065":[68,21,68,25],"2073":[66,5,66,9],"2081":[66,5,68,25],"2089":[66,5,68,26],"2097":[69,13,69,42],"2105":[69,45,69,54],"2113":[69,45,69,62],"2121":[69,68,69,73],"2129":[69,45,69,74],"2131":[69,45,69,67],"2137":[69,77,69,83],"2145":[69,86,69,90],"2153":[69,5,69,9],"2161":[69,5,69,90],"2169":[69,5,69,91],"2177":[70,13,70,22],"2185":[70,13,70,27],"2193":[71,16,71,18],"2201":[71,32,71,41],"2209":[71,44,71,51],"2217":[71,54,71,58],"2225":[71,16,71,59],"2227":[71,16,71,31],"2233":[71,16,71,59],"2241":[71,9,71,60],"2249":[70,32,72,6],"2257":[70,32,72,6],"2265":[70,32,72,6],"2273":[70,32,72,6],"2281":[70,13,72,7],"2283":[70,13,70,31],"2289":[72,13,72,17],"2297":[70,13,72,18],"2299":[70,13,72,12],"2305":[72,21,72,25],"2313":[70,5,70,9],"2321":[70,5,72,25],"2329":[70,5,72,26],"2337":[73,18,73,22],"2345":[73,18,73,26],"2353":[74,16,74,80],"2361":[74,83,74,87],"2369":[74,100,74,106],"2377":[74,107,74,110],"2385":[74,113,74,122],"2393":[74,125,74,132],"2401":[74,96,74,133],"2409":[74,135,74,137],"2417":[74,83,74,138],"2419":[74,83,74,95],"2425":[74,141,74,151],"2433":[74,16,74,151],"2441":[74,9,74,152],"2449":[73,31,75,6],"2457":[73,31,75,6],"2465":[73,31,75,6],"2473":[73,31,75,6],"2481":[73,18,75,7],"2483":[73,18,73,30],"2489":[75,13,75,17],"2497":[73,18,75,18],"2499":[73,18,75,12],"2505":[75,21,75,25],"2513":[73,18,75,25],"2521":[73,18,75,25],"2529":[76,5,76,11],"2537":[76,16,76,22],"2545":[76,24,76,34],"2553":[76,58,76,62],"2561":[76,46,76,64],"2569":[76,24,76,65],"2571":[76,24,76,45],"2577":[76,5,76,66],"2579":[76,5,76,15],"2585":[76,5,76,67],"2593":[77,5,77,11],"2601":[77,16,77,22],"2609":[77,24,77,34],"2617":[77,24,77,41],"2619":[77,24,77,39],"2625":[77,5,77,42],"2627":[77,5,77,15],"2633":[77,5,77,43],"2641":[78,5,78,11],"2649":[78,16,78,22],"2657":[78,24,78,31],"2665":[78,32,78,58],"2673":[78,24,78,59],"2681":[78,60,78,66],"2689":[78,60,78,71],"2697":[78,73,78,82],"2705":[78,24,78,83],"2713":[78,5,78,84],"2715":[78,5,78,15],"2721":[78,5,78,85],"2729":[79,5,79,11],"2737":[79,16,79,22],"2745":[80,9,80,15],"2753":[80,31,80,34],"2761":[80,36,80,43],"2769":[82,24,82,27],"2777":[82,24,82,32],"2785":[82,35,82,38],"2793":[82,35,82,43],"2801":[82,35,82,49],"2809":[82,53,82,56],"2817":[82,53,82,62],"2825":[82,53,82,68],"2833":[82,73,82,79],"2841":[82,82,82,87],"2849":[82,24,82,87],"2857":[82,17,82,88],"2865":[81,18,83,14],"2873":[81,18,83,14],"2881":[81,18,83,14],"2889":[80,45,84,10],"2897":[80,9,84,11],"2899":[80,9,80,30],"2905":[80,9,84,12],"2913":[85,16,85,20],"2921":[85,16,85,22],"2929":[85,16,85,22],"2937":[85,9,85,23],"2945":[79,24,86,6],"2953":[79,24,86,6],"2961":[79,24,86,6],"2969":[79,24,86,6],"2977":[79,24,86,6],"2985":[79,24,86,6],"2993":[79,5,86,7],"2995":[79,5,79,15],"3001":[79,5,86,8],"3009":[87,5,87,7],"3017":[87,20,87,29],"3025":[87,32,87,49],"3033":[87,5,87,50],"3035":[87,5,87,19],"3041":[88,13,88,17],"3049":[88,26,88,31],"3057":[88,13,88,32],"3059":[88,13,88,25],"3065":[88,37,88,41],"3073":[88,37,88,48],"3081":[88,51,88,52],"3089":[89,13,89,20],"3097":[89,21,89,30],"3105":[89,33,89,50],"3113":[89,53,89,57],"3121":[89,13,89,58],"3129":[89,59,89,65],"3137":[89,67,89,73],"3145":[89,75,89,84],"3153":[89,13,89,85],"3161":[89,13,89,86],"3169":[87,59,90,6],"3177":[87,59,90,6],"3185":[87,59,90,6],"3193":[87,59,90,6],"3201":[87,5,90,7],"3203":[87,5,87,58],"3209":[87,5,90,8],"3217":[91,5,91,11],"3225":[91,16,91,26],"3233":[92,9,92,12],"3241":[92,17,92,31],"3249":[92,33,92,50],"3257":[92,9,92,51],"3259":[92,9,92,16],"3265":[92,9,92,52],"3273":[93,9,93,12],"3281":[93,18,93,22],"3289":[93,9,93,23],"3291":[93,9,93,17],"3297":[93,9,93,24],"3305":[91,28,94,6],"3313":[91,28,94,6],"3321":[91,28,94,6],"3329":[91,28,94,6],"3337":[91,28,94,6],"3345":[91,5,94,7],"3347":[91,5,91,15],"3353":[91,5,94,8],"3361":[95,5,95,11],"3369":[95,16,95,28],"3377":[96,9,96,12],"3385":[96,17,96,31],"3393":[96,33,96,50],"3401":[96,9,96,51],"3403":[96,9,96,16],"3409":[96,9,96,52],"3417":[97,9,97,12],"3425":[97,18,97,24],"3433":[97,9,97,25],"3435":[97,9,97,17],"3441":[97,9,97,26],"3449":[95,30,98,6],"3457":[95,30,98,6],"3465":[95,30,98,6],"3473":[95,30,98,6],"3481":[95,30,98,6],"3489":[95,5,98,7],"3491":[95,5,95,15],"3497":[95,5,98,8],"3505":[99,17,99,19],"3513":[99,33,99,42],"3521":[99,45,99,60],"3529":[99,17,99,61],"3531":[99,17,99,32],"3537":[99,17,99,61],"3545":[99,17,99,61],"3553":[100,5,100,11],"3561":[100,16,100,27],"3569":[101,9,101,12],"3577":[101,20,101,49],"3585":[101,51,101,54],"3593":[101,9,101,55],"3595":[101,9,101,19],"3601":[101,9,101,56],"3609":[102,9,102,12],"3617":[102,20,102,50],"3625":[102,52,102,100],"3633":[102,9,102,101],"3635":[102,9,102,19],"3641":[102,9,102,102],"3649":[103,9,103,12],"3657":[103,18,103,23],"3665":[103,26,103,31],"3673":[103,35,103,38],"3681":[103,43,103,49],"3689":[103,35,103,50],"3691":[103,35,103,42],"3697":[103,53,103,59],"3705":[103,53,103,64],"3713":[103,68,103,75],"3721":[103,79,103,82],"3729":[103,79,103,89],"3737":[103,79,103,92],"3745":[103,96,103,104],"3753":[103,108,103,114],"3761":[103,9,103,115],"3763":[103,9,103,17],"3769":[103,9,103,116],"3777":[100,29,104,6],"3785":[100,29,104,6],"3793":[100,29,104,6],"3801":[100,29,104,6],"3809":[100,29,104,6],"3817":[100,29,104,6],"3825":[100,5,104,7],"3827":[100,5,100,15],"3833":[100,5,104,8],"3841":[105,5,105,11],"3849":[105,16,105,26],"3857":[105,28,105,35],"3865":[105,43,105,52],"3873":[105,55,105,65],"3881":[105,28,105,66],"3883":[105,28,105,42],"3889":[105,5,105,67],"3891":[105,5,105,15],"3897":[105,5,105,68],"3905":[106,5,106,11],"3913":[106,16,106,23],"3921":[106,31,106,40],"3929":[106,43,106,49],"3937":[106,16,106,50],"3939":[106,16,106,30],"3945":[106,5,106,51],"3947":[106,5,106,15],"3953":[106,5,106,52],"3961":[107,5,107,11],"3969":[108,14,108,17],"3977":[108,14,108,29],"3985":[109,13,109,16],"3993":[109,24,109,27],"4001":[109,24,109,42],"4009":[109,46,109,49],"4017":[109,13,109,50],"4019":[109,13,109,23],"4025":[109,63,109,66],"4033":[109,63,109,73],"4041":[109,78,109,88],"4049":[109,91,109,94],"4057":[110,24,110,31],"4065":[111,26,111,54],"4073":[109,97,112,14],"4081":[109,13,112,15],"4083":[109,13,109,55],"4089":[109,13,112,16],"4097":[113,14,113,17],"4105":[113,14,113,26],"4113":[113,30,113,33],"4121":[113,30,113,42],"4129":[113,46,113,53],"4137":[114,13,114,20],"4145":[114,25,114,28],"4153":[114,13,114,29],"4155":[114,13,114,24],"4161":[114,13,114,30],"4169":[115,13,115,20],"4177":[115,25,115,28],"4185":[115,25,115,34],"4193":[115,13,115,35],"4195":[115,13,115,24],"4201":[115,13,115,36],"4209":[107,16,117,6],"4217":[107,16,117,6],"4225":[107,16,117,6],"4233":[107,16,117,6],"4241":[107,16,117,6],"4249":[107,16,117,6],"4257":[107,16,117,6],"4265":[107,5,117,7],"4267":[107,5,107,15],"4273":[107,5,117,8],"4281":[118,12,118,18],"4289":[118,12,118,18],"4297":[118,5,118,19],"4305":[10,18,119,2],"4313":[10,18,119,2],"4321":[10,18,119,2],"4329":[10,18,119,2],"4337":[10,18,119,2],"4345":[10,18,119,2],"4353":[10,18,119,2],"4361":[10,18,119,2],"4369":[10,18,119,2],"4377":[10,18,119,2],"4385":[10,18,119,2],"4393":[10,18,119,2],"4401":[10,1,119,2],"4409":[10,1,119,3],"4417":[1,1,119,3],"4425":[1,1,119,3],"4433":[1,1,119,3],"4441":[1,1,119,3],"4449":[1,1,119,3],"4457":[1,1,119,3],"4465":[1,1,119,3],"4473":[1,1,119,3],"4481":[1,1,119,3],"4489":[13,19,15,10],"4497":[13,19,15,10],"4505":[12,23,16,6],"4513":[20,24,23,10],"4521":[20,24,23,10],"4529":[52,13,53,53],"4537":[41,9,54,10],"4545":[55,9,57,10],"4553":[40,28,58,6],"4561":[40,28,58,6],"4569":[66,25,68,6],"4577":[66,25,68,6],"4585":[70,32,72,6],"4593":[70,32,72,6],"4601":[73,31,75,6],"4609":[73,31,75,6],"4617":[82,24,82,87],"4625":[81,18,83,14],"4633":[81,18,83,14],"4641":[79,24,86,6],"4649":[79,24,86,6],"4657":[88,9,89,86],"4665":[87,59,90,6],"4673":[87,59,90,6],"4681":[91,28,94,6],"4689":[91,28,94,6],"4697":[95,30,98,6],"4705":[95,30,98,6],"4713":[100,29,104,6],"4721":[100,29,104,6],"4729":[109,56,112,14],"4737":[108,9,112,16],"4745":[113,9,116,10],"4753":[107,16,117,6],"4761":[107,16,117,6],"4769":[10,18,119,2],"4777":[10,18,119,2],"4785":[1,1,119,3],"4793":[1,1,119,3],"nBranches":26,"originalCodeFileName":"/home/blake/ExpoSE/Targets/gandhi/node_modules/gandhi/lib/index.js","instrumentedCodeFileName":"/home/blake/ExpoSE/Targets/gandhi/node_modules/gandhi/lib/index_jalangi_.js","code":"'use strict';\n\nvar fs = require('fs');\nvar _ = require('lodash');\nvar Q = require('q');\nvar Redis = require('ioredis');\nvar express = require('express');\nvar bodyParser = require('body-parser');\n\nmodule.exports = function(config){\n\tvar router = express.Router();\n\n\t// stub out a transporter if none is specified\n\tvar transporter = config.mail.transport ?\n\t\trequire('nodemailer').createTransport(config.mail.transport)\n\t\t: { sendMail: function(data, callback) { return callback(null, data); } };\n\n\t/*************\n\t * Resources *\n\t *************/\n\n\t// add resources\n\tvar resources = {\n\t\tdb: require('./api/utils/db.js')(config.db, config.pool.max, config.pool.min, config.pool.timeout),\n\t\tredis: new Redis(config.redis),\n\t\tmail: Q.nfbind(function(data, callback) {\n\t\t\t_.defaults(data, config.mail.defaults);\n\t\t\treturn transporter.sendMail(data, callback);\n\t\t}),\n\t\ttesters: {},\n\t\tlisteners: {},\n\t\tcomponents: {},\n\t\temailTemplates: {},\n\t\tactions: {}\n\t};\n\n\t// add lock\n\tresources.redlock = new (require('redlock'))([resources.redis], {\n\t\tretryCount: 5,\n\t\tretryDelay: 500\n\t});\n\n\t// add auth\n\tresources.auth = require('./api/utils/auth.js')(config, resources);\n\n\n\t/*************************\n\t * Dependency Management *\n\t *************************/\n\n\t// make sure bower directory exists\n\ttry { fs.mkdirSync(__dirname + '/app/assets/bower'); } catch(e) {}\n\n\t// add gandhi modules\n\tvar bowerJson = require('../bower.json');\n\tconfig.modules.forEach(function(directory){\n\n\t\t// add client side\n\t\tif(fs.existsSync(directory + '/bower.json')){\n\t\t\tvar json = require(directory + '/bower.json');\n\n\t\t\t// symlink into bower\n\t\t\ttry { fs.unlinkSync(__dirname + '/app/assets/bower/' + json.name); } catch(e) {}\n\t\t\ttry { fs.symlinkSync(directory, __dirname + '/app/assets/bower/' + json.name, 'dir'); } catch(e) {}\n\n\t\t\tbowerJson.dependencies[json.name] = __dirname + '/app/assets/bower/' + json.name;\n\n\t\t\t// add the angular module\n\t\t\tif(typeof json.module == 'string')\n\t\t\t\tbowerJson.modules.push(json.module);\n\t\t}\n\n\t\t// add server side\n\t\tif(fs.existsSync(directory + '/package.json')){\n\t\t\trequire(directory)(router, resources);\n\t\t}\n\t});\n\n\t// install dependencies\n\trequire('bower').commands.install(undefined, undefined, { cwd: __dirname + '/../' });\n\n\t// get all the bower deps\n\tvar deps = require('wiredep')({\n\t\tbowerJson: bowerJson,\n\t\tcwd: __dirname + '/../',\n\t\texclude: bowerJson.exclude\n\t});\n\tvar main = '';\n\n\t// require all the js files\n\tmain += deps.js.map(function(file){\n\t\treturn fs.readFileSync(file);\n\t}).join('\\n') + '\\n';\n\n\t// build the gandhi module\n\tmain += 'angular.module(\"gandhi\", [\"' + bowerJson.modules.join('\",\"') + '\"]);' + '\\n';\n\n\t// require source files\n\tmain += bowerJson.main.map(function(file){\n\t\treturn fs.readFileSync(__dirname + '/app/' + file);\n\t}).join('\\n') + '\\n';\n\n\t// require all the css files\n\tvar styles = deps.css.map(function(file){\n\t\treturn 'document.write(\\'<link rel=\"stylesheet\" type=\"text/css\" href=\"' + file.replace(new RegExp('^'+__dirname+'/app/'), '') + '\" />\\');';\n\t}).join('\\n') + '\\n';\n\n\n\t/***********\n\t * Routing *\n\t ***********/\n\n\t// add middleware\n\trouter.use('/api', bodyParser.urlencoded({extended: true}));\n\trouter.use('/api', bodyParser.json());\n\trouter.use('/api', require('./api/middleware/auth.js')(config.auth, resources));\n\n\t// TODO: this is stupidly inefficient, but auth is done in a route-specific way right now. Let's fix that in the future and drop passport.\n\trouter.use('/api', function(req, res, next) {\n\t\tObject.defineProperty(req, 'admin', {\n\t\t\tget: function(){\n\t\t\t\treturn req.user ? req.user.admin && req.query.admin === 'true' : false;\n\t\t\t}\n\t\t});\n\n\t\treturn next();\n\t});\n\n\t// add the endpoints\n\tfs.readdirSync(__dirname + '/api/endpoints/').forEach(function(file){\n\t\tif(file.indexOf('.js') === (file.length - 3))\n\t\t\trequire(__dirname + '/api/endpoints/' + file)(config, router, resources);\n\t});\n\n\t// serve main.js\n\trouter.get('/main.js', function(req, res) {\n\t\tres.set('Content-Type','text/javascript');\n\t\tres.send(main);\n\t});\n\n\t// serve styles.js\n\trouter.get('/styles.js', function(req, res) {\n\t\tres.set('Content-Type','text/javascript');\n\t\tres.send(styles);\n\t});\n\n\t// get the embed script\n\tvar embed = fs.readFileSync(__dirname + '/app/embed.js');\n\trouter.get('/embed.js', function(req, res, next) {\n\t\tres.header('Access-Control-Allow-Origin', '*');\n\t\tres.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');\n\t\tres.send(embed + '(\\'' + (req.get('host') + config.root)  + '\\',\\'' + (req.params.id || 'gandhi') + '\\');');\n\t});\n\n\t// serve static files\n\trouter.use('/modules', express.static(__dirname + '/modules'));\n\trouter.use(express.static(__dirname + '/app'));\n\n\t// error handling\n\trouter.use(function(err, req, res, next) {\n\n\t\t// make sure to respond if we haven't yet\n\t\tif(!res._headerSent) res.status(err.httpStatusCode || 500).send(\n\n\t\t\t// don't show system errors to the client\n\t\t\t(typeof err.toJSON === 'function') ?\n\t\t\t\terr\n\t\t\t\t: {error: 'Error', message: 'An unknown error occurred.'}\n\n\t\t);\n\n\t\t// // log the error\n\t\t// console[err.logLevel || 'error']({\n\t\t// \terror: err,\n\t\t// \trequest: {\n\t\t// \t\tmethod: req.method,\n\t\t// \t\turl: req.url,\n\t\t// \t\tparams: req.params,\n\t\t// \t\tbody: req.body\n\t\t// \t},\n\t\t// \tresponse: {\n\t\t// \t\tstatusCode: res.statusCode,\n\t\t// \t\tbody: res.body\n\t\t// \t}\n\t\t// });\n\n\t\tif(!err.logLevel || err.logLevel == 'error') {\n\t\t\tconsole.log(err);\n\t\t\tconsole.log(err.stack);\n\t\t}\n\t});\n\n\n\treturn router;\n};\n"}