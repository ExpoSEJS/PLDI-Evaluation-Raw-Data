"use strict";(function(){function t(t){return t.charAt(0).toUpperCase()+t.slice(1)}var e=this,r=e._,n=e.qclass;if("undefined"==typeof r){if("undefined"==typeof require)throw new Error("typedmodel requires lodash");r=require("lodash"),n=require("qclass")}var i=null,o={bool:{checkFn:function(t){return r.isNull(t)||r.isBoolean(t)}},string:{checkFn:function(t){return r.isNull(t)||r.isString(t)}},number:{checkFn:function(t){return r.isNull(t)||r.isNumber(t)}},date:{checkFn:function(t){return r.isNull(t)||r.isDate(t)}},array:{checkFn:function(t){return r.isNull(t)||r.isArray(t)}}},u=n({$hooks:function(){this.prototype.constructor=this},$construct:function(e,n,a){var s={},l=!1,f=!1,c=[],h={},p=this;null==n&&(n={}),n.hasOwnProperty("JSON")||(n.JSON={});var d=function(t,e,n){var i={};for(var o in s){var a=s[o];if(r.isNull(a.value))i[o]=null;else if(r.isEqual(a.type,"array"))for(var l=i[o]=[],f=0;f<a.value.length;++f){var c=a.value[f];l.push(c instanceof u?c[e](n):c)}else i[o]=r.isEqual(a.type,"model")||r.isEqual(a.type,"arraymodel")?a.value[e](n):a.value}return t.isDeleted()&&(i=t.primaryKey(),i&&(i.deleted=!0)),i};r.forEach(n,function(e,n){var i=t(n);p["from"+i]=function(t,n){return r.isFunction(e.fromFn)?void e.fromFn(t,p,n):void r.forEach(t,function(t,e){var r=s[e];if(null!=r){var o={};if("model"===r.type||"arraymodel"===r.type){var u=new r.Type;u["from"+i](t,n),o[e]=u}else o[e]=t;p.set(o)}})},p["to"+i]=function(t){return t||(t={}),r.isFunction(e.toFn)?e.toFn(p,t):d(p,"to"+i,t)}});for(var v in e){var y=e[v];if(!r.isObject(y))throw new Error("Invalid property. Property must be an object");if(r.isUndefined(y).$type)throw new Error("Invalid property type. Undefined $type attribute");var m=y.$type;y.$pk&&(c.push(v),h[v]=!0);var w=null;if((y.$default||r.isEqual(y.$default,""))&&(w=r.isFunction(y.$default)?y.$default():y.$default),o.hasOwnProperty(m))s[v]={type:m,checkFn:o[m].checkFn,value:w};else{var b=new m;if(b instanceof u)s[v]={type:"model",Type:m,checkFn:function(t){if(r.isNull(t))return!0;var e=this.Type;return e.prototype.isPrototypeOf(t)},value:w};else{if(!(b instanceof i))throw new Error("Invalid property type "+v);s[v]={type:"arraymodel",Type:m,checkFn:function(t){if(r.isNull(t))return!0;var e=this.Type;return e.prototype.isPrototypeOf(t)},value:w}}}if(!s[v].checkFn(w))throw new Error("Invalid $default value for key "+v+": "+w)}var E=function(t,e,i){if(r.isObject(n)&&n.hasOwnProperty(e)&&r.isFunction(n[e].fromFn))return void n[e].fromFn(t,p,i);throw new Error("Cannot convert it to "+e)};this.set=function(t,e,n){if(f)throw new Error("Object is immutable");if(!r.isObject(t))throw new Error("Invalid object");if(e)return void E(t,e,n);for(var i in t){if(!s.hasOwnProperty(i))throw new Error("Invalid attribute "+i);if(s[i].checkFn(t[i]))s[i].value=t[i];else{if(!r.isUndefined(t[i]))throw new Error("Invalid attribute "+i);s[i].value=null}}},this.get=function(t){if(!s.hasOwnProperty(t))throw new Error("Trying to access an invalid key");return s[t].value},this.attributeNames=function(){return Object.keys(s)},this.primaryKey=function(){if(!c.length)return null;var t={};return r.forEach(c,function(e){t[e]=s[e].value}),t},this.toString=function(){return JSON.stringify(this.toJSON(),null,2)},this.isEqual=function(t){if(r.isEqual(this,t))return!0;if(!r.isEqual(this.attributeNames(),t.attributeNames()))return!1;for(var e in s){var n=s[e],i=t.get(e);if(r.isEqual(n.type,"model")){if(!n.value.isEqual(i))return!1}else if(n.value!==i)return!1}return!0},this.setDeleted=function(){l=!0},this.isDeleted=function(){return l},this.copy=function(){return f?this:this.mutableCopy()},this.mutableCopy=function(){var t=this.constructor,e=new t;return r.forEach(s,function(t,n){var o={};o[n]=t.value instanceof u||t.value instanceof i?t.value.mutableCopy():r.cloneDeep(t.value),e.set(o)}),e};var O=function(t,e,r){var n={};n[t]=e,r.set(n)};this.diff=function(t){if(r.isEqual(this,t))return null;if(!t){var e=this.mutableCopy();return e.setDeleted(),e.immutable(),e}var n=this.constructor,o=new n;if(a)return a(this,t,o);for(var s=!1,l=this.attributeNames(),f=0;f<l.length;++f){var c=l[f],p=this.get(c),d=t.get(c);if(p instanceof u||p instanceof i){var v=p.diff(d);v?(O(c,v,o),s=!0):o.removeAttribute(c)}else if(h.hasOwnProperty(c)){if(!r.isEqual(p,d))throw new Error(c+" must have same value "+p+", "+d);r.isNull(p)?O(c,null,o):O(c,p,o)}else r.isEqual(p,d)?o.removeAttribute(c):(O(c,d,o),s=!0)}return s?o:null},this.removeAttribute=function(t){if(f)throw new Error("Object is Immutable");delete s[t]},this.immutable=function(){f=!0;for(var t in s){var e=s[t];r.isEqual(e.type,"model")&&e.value&&!e.value.isImmutable()&&e.value.immutable()}return this},this.isImmutable=function(){return f},Object.freeze(this)}}),a=n({$hooks:function(){this.prototype.constructor=this},$construct:function(e,n,i){if(!new e instanceof u)throw new Error("Type must be inherit from Model");var o=[],a=!1,s=this,l=function(t,e,r){var n=[];return t.each(function(t){n.push(t[e](r))}),n};null==n&&(n={}),n.hasOwnProperty("JSON")||(n.JSON={}),r.forEach(n,function(n,i){var o=t(i);s["from"+o]=function(t,i){return r.isFunction(n.fromFn)?void n.fromFn(t,s,i):void r.forEach(t,function(t){var r=new e;r["from"+o](t,i),s.append(r)})},s["to"+o]=function(t){return t||(t={}),r.isFunction(n.toFn)?n.toFn(s,t):l(s,"to"+o,t)}}),this.insertAt=function(t,r){if(a)throw new Error("Object is immutable");if(o.length<t)throw new Error("Can't insert in the desired index");if(!(r instanceof e))throw new Error("Cannot add the object. Invalid type");o.splice(t,0,r)},this.append=function(t){if(a)throw new Error("Object is immutable");if(!(t instanceof e))throw new Error("Cannot add the object. Invalid type");o.push(t)},this.prepend=function(t){this.insertAt(0,t)},this.removeAt=function(t){if(a)throw new Error("Object is immutable");o.splice(t,1)},this.replaceAt=function(t,e){if(a)throw new Error("Object is immutable");o.splice(t,1,e)},this.get=function(t){return o[t]},this.length=function(){return o.length},this.toString=function(){return JSON.stringify(this.toJSON(),null,2)},this.isEqual=function(t){if(r.isEqual(t,this))return!0;if(t.length()!=this.length())return!1;for(var e=0;e<o.length;++e)if(!this.get(e).isEqual(t.get(e)))return!1;return!0},this.isEmpty=function(){return 0==o.length},this.each=function(t){r.forEach(o,t)},this.copy=function(){return a?this:this.mutableCopy()},this.mutableCopy=function(){var t=this.constructor,e=new t;return r.forEach(o,function(t){e.append(t.mutableCopy())}),e},this.diff=function(t){if(r.isEqual(this,t))return null;var e=this.constructor,n=new e;if(!t){for(var u=0;u<o.length;++u)n.append(o[u].diff(null));return n}if(i)return i(this,t,n);var a,s,l,f={};for(u=0;u<o.length;++u){a=o[u].primaryKey();for(s in a)if(r.isNull(a[s])){a=null;break}a&&(s=JSON.stringify(a),f[s]=o[u])}if(!a){var c=this.toJSON(),h=t.toJSON();return r.isEqual(c,h)?null:t.mutableCopy()}for(u=0;u<t.length();++u)if(a=t.get(u).primaryKey(),s=JSON.stringify(a),f.hasOwnProperty(s))l=f[s].diff(t.get(u)),l&&n.append(l),delete f[s];else{var p=t.get(u).mutableCopy();n.append(p)}for(s in f)n.append(f[s].diff(null));return n.length()?n:null},this.immutable=function(){return a=!0,r.forEach(o,function(t){t.immutable()}),this},this.isImmutable=function(){return a},Object.freeze(this)}});"undefined"!=typeof module&&module.exports?(module.exports.Model=u,module.exports.ArrayModel=a):(e.Model=u,e.ArrayModel=a),"function"==typeof define&&define.amd&&define("typedmodel",[],function(){return{Model:u,ArrayModel:a}}),i=a}).call(this);
