
> dtrace-provider@0.8.5 install /root/Targets/triton/node_modules/dtrace-provider
> node scripts/install.js

/root/Targets/triton
└─┬ triton@5.4.0 
  ├── assert-plus@0.2.0 
  ├─┬ backoff@2.4.1 
  │ └── precond@0.2.3 
  ├── bigspinner@3.1.0 
  ├─┬ bunyan@1.8.12 
  │ ├─┬ dtrace-provider@0.8.5 
  │ │ └── nan@2.7.0 
  │ ├── moment@2.18.1 
  │ ├─┬ mv@2.1.1 
  │ │ └── ncp@2.0.0 
  │ └── safe-json-stringify@1.0.4 
  ├─┬ cmdln@4.1.2 
  │ ├── assert-plus@1.0.0 
  │ ├─┬ dashdash@1.14.1 
  │ │ └── assert-plus@1.0.0 
  │ ├── extsprintf@1.3.0 
  │ └── fuzzyset.js@0.0.1 
  ├── extsprintf@1.0.2 
  ├─┬ getpass@0.1.6 
  │ └── assert-plus@1.0.0 
  ├─┬ jsprim@1.4.0 
  │ ├── assert-plus@1.0.0 
  │ ├── json-schema@0.2.3 
  │ └── verror@1.3.6 
  ├─┬ lomstream@1.1.0 
  │ ├── assert-plus@0.1.5 
  │ ├── extsprintf@1.3.0 
  │ └─┬ vstream@0.1.0 
  │   ├── assert-plus@0.1.5 
  │   └── extsprintf@1.2.0 
  ├─┬ mkdirp@0.5.1 
  │ └── minimist@0.0.8 
  ├─┬ once@1.3.2 
  │ └── wrappy@1.0.2 
  ├─┬ read@1.0.7 
  │ └── mute-stream@0.0.7 
  ├─┬ restify-clients@1.5.2 
  │ ├── assert-plus@1.0.0 
  │ ├── fast-safe-stringify@1.2.0 
  │ ├── keep-alive-agent@0.0.1 
  │ ├── lodash@4.17.4 
  │ ├─┬ lru-cache@4.1.1 
  │ │ ├── pseudomap@1.0.2 
  │ │ └── yallist@2.1.2 
  │ ├── mime@1.4.1 
  │ ├─┬ restify-errors@3.1.0 
  │ │ ├── assert-plus@0.2.0 
  │ │ └── lodash@3.10.1 
  │ ├─┬ tunnel-agent@0.6.0 
  │ │ └── safe-buffer@5.1.1 
  │ └── uuid@3.1.0 
  ├─┬ restify-errors@3.0.0 
  │ ├── assert-plus@0.1.5 
  │ └── lodash@3.10.1 
  ├─┬ rimraf@2.4.4 
  │ └─┬ glob@5.0.15 
  │   ├── inflight@1.0.6 
  │   ├── inherits@2.0.3 
  │   ├─┬ minimatch@3.0.4 
  │   │ └─┬ brace-expansion@1.1.8 
  │   │   ├── balanced-match@1.0.0 
  │   │   └── concat-map@0.0.1 
  │   └── path-is-absolute@1.0.1 
  ├── semver@5.1.0 
  ├─┬ smartdc-auth@2.5.6 
  │ ├── assert-plus@1.0.0 
  │ ├── clone@0.1.5 
  │ ├─┬ dashdash@1.10.1 
  │ │ └── assert-plus@0.1.5 
  │ ├─┬ http-signature@1.2.0 
  │ │ └── assert-plus@1.0.0 
  │ ├── once@1.3.0 
  │ └─┬ vasync@1.4.3 
  │   ├─┬ jsprim@0.3.0 
  │   │ ├── extsprintf@1.0.0 
  │   │ ├── json-schema@0.2.2 
  │   │ └── verror@1.3.3 
  │   └── verror@1.1.0 
  ├─┬ sshpk@1.10.2 
  │ ├── asn1@0.2.3 
  │ ├── assert-plus@1.0.0 
  │ ├── bcrypt-pbkdf@1.0.1 
  │ ├── ecc-jsbn@0.1.1 
  │ ├── jodid25519@1.0.2 
  │ ├── jsbn@0.1.1 
  │ └── tweetnacl@0.14.5 
  ├─┬ sshpk-agent@1.4.2 
  │ ├── assert-plus@1.0.0 
  │ ├── mooremachine@2.2.0 
  │ └─┬ readable-stream@2.3.3 
  │   ├── isarray@1.0.0 
  │   ├── process-nextick-args@1.0.7 
  │   ├── string_decoder@1.0.3 
  │   └── util-deprecate@1.0.2 
  ├── strsplit@1.0.0 
  ├─┬ tabula@1.9.0 
  │ ├── assert-plus@1.0.0 
  │ └── lstream@0.0.4 
  ├─┬ vasync@1.6.3 
  │ └─┬ verror@1.6.0 
  │   └── extsprintf@1.2.0 
  ├─┬ verror@1.10.0 
  │ ├── assert-plus@1.0.0 
  │ ├── core-util-is@1.0.2 
  │ └── extsprintf@1.3.0 
  ├─┬ which@1.2.4 
  │ ├─┬ is-absolute@0.1.7 
  │ │ └── is-relative@0.1.3 
  │ └── isexe@1.1.2 
  └── wordwrap@1.0.0 

Setup Done exists, not setting up
:../FeatureTester/libs/:/root/Targets/triton/node_modules
Set Default Z3_PATH to ./node_modules/z3javascript/bin/libz3.so
ExpoSE Master: /root/ExpoSE/lib/Harness/src/harness.js max concurrent: 16 max paths: 1000000
Setting timeout to 900000
*** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [1 done /0 queued / 0 running / 1 errors / 33% coverage ] ***
*-- Stat Module Output --*
*-- concretizations: ["defineProperty","bound log"]
*-- Stat Module Done --*
*-- Test Case {"_bound":0} start 0.074 took 3.9818s
*-- Errors occured in test {"_bound":0}
* Error: Tropigate failed because SyntaxError: Unexpected token (11:4) on program /*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/.
 */

/*
 * Copyright 2016 Joyent, Inc.
 */

var assert = require('assert-plus');
var vasync = require('vasync');

var bunyannoop = require('./bunyannoop');
var mod_common = require('./common');
var mod_config = require('./config');
var mod_cloudapi2 = require('./cloudapi2');
var mod_tritonapi = require('./tritonapi');


/* BEGIN JSSTYLED */
/**
 * A convenience wrapper around `tritonapi.TritonApi` for simpler usage.
 * Conveniences are:
 * - It wraps up the 3-step process of TritonApi client preparation into
 *   this one call.
 * - It accepts optional `profileName` and `configDir` parameters that will
 *   load a profile by name and load a config, respectively.
 *
 * Client preparation is a 3-step process:
 *
 *  1. create the client object;
 *  2. initialize it (mainly involves finding the SSH key identified by the
 *     `keyId`); and,
 *  3. optionally unlock the SSH key (if it is passphrase-protected and not in
 *     an ssh-agent).
 *
 * The simplest usage that handles all of these is:
 *
 *      var mod_triton = require('triton');
 *      mod_triton.createClient({
 *          profileName: 'env',
 *          unlockKeyFn: triton.promptPassphraseUnlockKey
 *      }, function (err, client) {
 *          if (err) {
 *              // handle err
 *          }
 *
 *          // use `client`
 *      });
 *
 * Minimally, only of `profileName` or `profile` is required. Examples:
 *
 *      // Manually specify profile parameters.
 *      mod_triton.createClient({
 *          profile: {
 *              url: "<cloudapi url>",
 *              account: "<account login for this cloud>",
 *              keyId: "<ssh key fingerprint for one of account's keys>"
 *          }
 *      }, function (err, client) { ... });
 *
 *      // Loading a profile from the environment (the `TRITON_*` and/or
 *      // `SDC_*` environment variables).
 *      triton.createClient({profileName: 'env'},
 *          function (err, client) { ... });
 *
 *      // Use one of the named profiles from the `triton` CLI.
 *      triton.createClient({
 *          configDir: '~/.triton',
 *          profileName: 'east1'
 *      }, function (err, client) { ... });
 *
 *      // The same thing using the underlying APIs.
 *      triton.createClient({
 *          config: triton.loadConfig({configDir: '~/.triton'}),
 *          profile: triton.loadProfile({name: 'east1', configDir: '~/.triton'})
 *      }, function (err, client) { ... });
 *
 * TODO: The story for an app wanting to specify some Triton config but NOT
 * have to have a triton $configDir/config.json is poor.
 *
 *
 * # What is that `unlockKeyFn` about?
 *
 * Triton uses HTTP-Signature auth: an SSH private key is used to sign requests.
 * The server-side authenticates by verifying that signature using the
 * previously uploaded public key. For the client to sign a request it needs an
 * unlocked private key: an SSH private key that (a) is not
 * passphrase-protected, (b) is loaded in an ssh-agent, or (c) for which we
 * have a passphrase.
 *
 * If `createClient` finds that its key is locked, it will use `unlockKeyFn`
 * as follows to attempt to unlock it:
 *
 *      unlockKeyFn({
 *          tritonapi: client
 *      }, function (unlockErr) {
 *          // ...
 *      });
 *
 * This package exports a convenience `promptPassphraseUnlockKey` function that
 * will prompt the user for a passphrase on stdin. Your tooling can use this
 * function, provide your own, or skip key unlocking.
 *
 * The failure mode for a locked key is an error like this:
 *
 *      SigningError: error signing request: SSH private key id_rsa is locked (encrypted/password-protected). It must be unlocked before use.
 *          at SigningError._TritonBaseVError (/Users/trentm/tmp/node-triton/lib/errors.js:55:12)
 *          at new SigningError (/Users/trentm/tmp/node-triton/lib/errors.js:173:23)
 *          at CloudApi._getAuthHeaders (/Users/trentm/tmp/node-triton/lib/cloudapi2.js:185:22)
 *
 *
 * @param opts {Object}:
 *      - @param profile {Object} A *Triton profile* object that includes the
 *        information required to connect to a CloudAPI -- minimally this:
 *              {
 *                  "url": "<cloudapi url>",
 *                  "account": "<account login for this cloud>",
 *                  "keyId": "<ssh key fingerprint for one of account's keys>"
 *              }
 *        For example:
 *              {
 *                  "url": "https://us-east-1.api.joyent.com",
 *                  "account": "billy.bob",
 *                  "keyId": "de:e7:73:9a:aa:91:bb:3e:72:8d:cc:62:ca:58:a2:ec"
 *              }
 *        Either `profile` or `profileName` is requires. See discussion above.
 *      - @param profileName {String} A Triton profile name. For any profile
 *        name other than "env", one must also provide either `configDir`
 *        or `config`.
 *        Either `profile` or `profileName` is required. See discussion above.
 *      - @param configDir {String} A base config directory. This is used
 *        by TritonApi to find and store profiles, config, and cache data.
 *        For example, the `triton` CLI uses "~/.triton".
 *        One may not specify both `configDir` and `config`.
 *      - @param config {Object} A Triton config object loaded by
 *        `triton.loadConfig(...)`.
 *        One may not specify both `configDir` and `config`.
 *      - @param log {Bunyan Logger} Optional. A Bunyan logger. If not provided,
 *        a stub that does no logging will be used.
 *      - @param {Function} unlockKeyFn - Optional. A function to handle
 *        unlocking the SSH key found for this profile, if necessary. It must
 *        be of the form `function (opts, cb)` where `opts.tritonapi` is the
 *        initialized TritonApi client. If the caller is a command-line
 *        interface, then `triton.promptPassphraseUnlockKey` can be used to
 *        prompt on stdin for the SSH key passphrase, if needed.
 * @param {Function} cb - `function (err, client)`
 */
/* END JSSTYLED */
function createClient(opts, cb) {
    assert.object(opts, 'opts');
    assert.optionalObject(opts.profile, 'opts.profile');
    assert.optionalString(opts.profileName, 'opts.profileName');
    assert.optionalObject(opts.config, 'opts.config');
    assert.optionalString(opts.configDir, 'opts.configDir');
    assert.optionalObject(opts.log, 'opts.log');
    assert.optionalFunc(opts.unlockKeyFn, 'opts.unlockKeyFn');
    assert.func(cb, 'cb');

    assert.ok(!(opts.profile && opts.profileName),
        'cannot specify both opts.profile and opts.profileName');
    assert.ok(!(!opts.profile && !opts.profileName),
        'must specify one opts.profile or opts.profileName');
    assert.ok(!(opts.config && opts.configDir),
        'cannot specify both opts.config and opts.configDir');
    assert.ok(!(opts.config && opts.configDir),
        'cannot specify both opts.config and opts.configDir');
    if (opts.profileName && opts.profileName !== 'env') {
        assert.ok(opts.configDir,
            'must provide opts.configDir for opts.profileName!="env"');
    }

    var log;
    var client;

    vasync.pipeline({funcs: [
        function theSyncPart(_, next) {
            log = opts.log || new bunyannoop.BunyanNoopLogger();

            var config;
            if (opts.config) {
                config = opts.config;
            } else {
                try {
                    config = mod_config.loadConfig(
                        {configDir: opts.configDir});
                } catch (configErr) {
                    next(configErr);
                    return;
                }
            }

            var profile;
            if (opts.profile) {
                profile = opts.profile;
                /*
                 * Don't require one to arbitrarily have a profile.name if
                 * manually creating it.
                 */
                if (!profile.name) {
                    // TODO: might want this to be a hash/slug of params.
                    profile.name = '_';
                }
            } else {
                try {
                    profile = mod_config.loadProfile({
                        name: opts.profileName,
                        configDir: config._configDir
                    });
                } catch (profileErr) {
                    next(profileErr);
                    return;
                }
            }
            try {
                mod_config.validateProfile(profile);
            } catch (valErr) {
                next(valErr);
                return;
            }

            client = mod_tritonapi.createClient({
                log: log,
                config: config,
                profile: profile
            });
            next();
        },
        function initTheClient(_, next) {
            client.init(next);
        },
        function optionallyUnlockKey(_, next) {
            if (!opts.unlockKeyFn) {
                next();
                return;
            }

            opts.unlockKeyFn({tritonapi: client}, next);
        }
    ]}, function (err) {
        log.trace({err: err}, 'createClient complete');
        if (err) {
            cb(err);
        } else {
            cb(null, client);
        }
    });
}


module.exports = {
    createClient: createClient,
    promptPassphraseUnlockKey: mod_common.promptPassphraseUnlockKey,

    /**
     * `createClient` provides convenience parameters to not *have* to call
     * the following (i.e. passing in `configDir` and/or `profileName`), but
     * some users of node-triton as a module may want to call these directly.
     */
    loadConfig: mod_config.loadConfig,
    loadProfile: mod_config.loadProfile,
    loadAllProfiles: mod_config.loadAllProfiles,

    /*
     * For those wanting a lower-level TritonApi createClient, or an
     * even *lower*-level raw CloudAPI client.
     */
    createTritonApiClient: mod_tritonapi.createClient,
    createCloudApiClient: mod_cloudapi2.createClient
};
 at SyntaxError: Unexpected token (11:4)
    at Parser.pp$4.raise (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2221:15)
    at Parser.pp.unexpected (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:603:10)
    at Parser.pp$2.parseBindingAtom (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1417:12)
    at Parser.parseBindingAtom (/root/ExpoSE/lib/Tropigate/bin/FunctionSignatures.js:49:30)
    at Parser.pp$1.parseVarId (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1049:20)
    at Parser.pp$1.parseVar (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1032:14)
    at Parser.pp$1.parseVarStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:917:10)
    at Parser.pp$1.parseStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:706:19)
    at Parser.parseStatement (/root/ExpoSE/lib/Tropigate/bin/Statements.js:104:30)
    at Parser.pp$1.parseTopLevel (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:638:25)
*-- Replay with NO_COMPILE=1 expoSE replay '/root/ExpoSE/lib/Harness/src/harness.js' '{"_bound":0}'
*-- Coverage Data
*- File /root/ExpoSE/lib/Harness/src/harness.js. Coverage (Term): 18% Coverage (LOC): 24%
*- File /root/ExpoSE/lib/S$/bin/symbols.js. Coverage (Term): 16% Coverage (LOC): 34%
*- Re-run with EXPOSE_PRINT_COVERAGE=1 to print line by line coverage information
** ExpoSE Finished. 1 paths with 1 errors **
