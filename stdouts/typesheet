/root/Targets/typesheet
└─┬ typesheet@0.9.5 
  ├─┬ chokidar@1.7.0 
  │ ├─┬ anymatch@1.3.2 
  │ │ ├─┬ micromatch@2.3.11 
  │ │ │ ├─┬ arr-diff@2.0.0 
  │ │ │ │ └── arr-flatten@1.1.0 
  │ │ │ ├── array-unique@0.2.1 
  │ │ │ ├─┬ braces@1.8.5 
  │ │ │ │ ├─┬ expand-range@1.8.2 
  │ │ │ │ │ └─┬ fill-range@2.2.3 
  │ │ │ │ │   ├── is-number@2.1.0 
  │ │ │ │ │   ├── isobject@2.1.0 
  │ │ │ │ │   ├─┬ randomatic@1.1.7 
  │ │ │ │ │   │ ├─┬ is-number@3.0.0 
  │ │ │ │ │   │ │ └── kind-of@3.2.2 
  │ │ │ │ │   │ └── kind-of@4.0.0 
  │ │ │ │ │   └── repeat-string@1.6.1 
  │ │ │ │ ├── preserve@0.2.0 
  │ │ │ │ └── repeat-element@1.1.2 
  │ │ │ ├─┬ expand-brackets@0.1.5 
  │ │ │ │ └── is-posix-bracket@0.1.1 
  │ │ │ ├── extglob@0.3.2 
  │ │ │ ├── filename-regex@2.0.1 
  │ │ │ ├─┬ kind-of@3.2.2 
  │ │ │ │ └── is-buffer@1.1.5 
  │ │ │ ├─┬ object.omit@2.0.1 
  │ │ │ │ ├─┬ for-own@0.1.5 
  │ │ │ │ │ └── for-in@1.0.2 
  │ │ │ │ └── is-extendable@0.1.1 
  │ │ │ ├─┬ parse-glob@3.0.4 
  │ │ │ │ ├── glob-base@0.3.0 
  │ │ │ │ └── is-dotfile@1.0.3 
  │ │ │ └─┬ regex-cache@0.4.4 
  │ │ │   └─┬ is-equal-shallow@0.1.3 
  │ │ │     └── is-primitive@2.0.0 
  │ │ └─┬ normalize-path@2.1.1 
  │ │   └── remove-trailing-separator@1.1.0 
  │ ├── async-each@1.0.1 
  │ ├── glob-parent@2.0.0 
  │ ├── inherits@2.0.3 
  │ ├─┬ is-binary-path@1.0.1 
  │ │ └── binary-extensions@1.10.0 
  │ ├─┬ is-glob@2.0.1 
  │ │ └── is-extglob@1.0.0 
  │ ├── path-is-absolute@1.0.1 
  │ └─┬ readdirp@2.1.0 
  │   ├── graceful-fs@4.1.11 
  │   ├─┬ minimatch@3.0.4 
  │   │ └─┬ brace-expansion@1.1.8 
  │   │   ├── balanced-match@1.0.0 
  │   │   └── concat-map@0.0.1 
  │   ├─┬ readable-stream@2.3.3 
  │   │ ├── core-util-is@1.0.2 
  │   │ ├── isarray@1.0.0 
  │   │ ├── process-nextick-args@1.0.7 
  │   │ ├── safe-buffer@5.1.1 
  │   │ ├── string_decoder@1.0.3 
  │   │ └── util-deprecate@1.0.2 
  │   └── set-immediate-shim@1.0.1 
  ├── htmlparser@1.7.7 
  ├── ix@1.0.6 
  ├── minimist@1.2.0 
  ├── mkpath@1.0.0 
  └── rx@4.1.0 

Setup Done exists, not setting up
:../FeatureTester/libs/:/root/Targets/typesheet/node_modules
Set Default Z3_PATH to ./node_modules/z3javascript/bin/libz3.so
ExpoSE Master: /root/ExpoSE/lib/Harness/src/harness.js max concurrent: 16 max paths: 1000000
Setting timeout to 900000
*** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [1 done /0 queued / 0 running / 1 errors / 33% coverage ] ***
*-- Stat Module Output --*
*-- concretizations: ["defineProperty","bound log"]
*-- Stat Module Done --*
*-- Test Case {"_bound":0} start 0.0464 took 3.0879s
*-- Errors occured in test {"_bound":0}
* Error: Tropigate failed because SyntaxError: Unexpected character '#' (1:78) on program #!/usr/bin/env node
/// <reference path="typings/chokidar/chokidar.d.ts" />
/// <reference path="typings/ix.js/ix.d.ts" />
/// <reference path="typings/rx/rx.all.d.ts" />
/// <reference path="typings/minimist/minimist.d.ts" />
/// <reference path="typings/mkpath/mkpath.d.ts" />
var chokidar = require('chokidar');
var fs = require('fs');
var path = require('path');
var minimist = require('minimist');
var mkpath = require('mkpath');
var ix_1 = require('ix');
var Rx = require('rx');
var htmlparser = require("htmlparser");
var defaultOptions = {
    init: false,
    output: 'Scripts/TypeSheet',
    help: false,
    filterRegex: '^js'
};
var version = '0.9.5';
var reservedKeywordsRegex = /^(do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/g;
var validSelectorRegex = /^[a-zA-Z]+[a-zA-Z0-9\-_]*$/;
var dotfileRegex = /[\/\\]\./;
function traverseChildren(children) {
    return ix_1.Enumerable
        .fromArray(children.filter(function (x) { return x.type == "tag"; }))
        .selectMany(traverseChild);
}
function traverseChild(_a) {
    var raw = _a.raw, attribs = _a.attribs, children = _a.children;
    var flatChildren = traverseChildren(children || []);
    if (attribs) {
        var id = attribs.id && attribs.id.trim() || "";
        var classes = attribs.class && attribs.class.trim().split(' ').filter(function (x) { return x.trim().length > 0; }) || [];
        if (id.length > 0 || classes.length > 0) {
            return flatChildren.concat(ix_1.Enumerable.return({ raw: raw, id: id, classes: classes }));
        }
    }
    return flatChildren;
}
function watch(filesOrGlobs, initalPass) {
    var subject = new Rx.Subject();
    var watcher = chokidar.watch(filesOrGlobs, { ignored: dotfileRegex, });
    watcher.on('change', function (path) { return subject.onNext(path); });
    if (initalPass) {
        watcher.on('add', function (path) { return subject.onNext(path); });
    }
    watcher.on('error', function (error) { return subject.onError(error); });
    return subject.asObservable();
}
function readFile(filePath) {
    var fileSubject = new Rx.Subject();
    fs.readFile(filePath, 'utf-8', function (error, data) {
        if (error) {
            fileSubject.onError(error);
        }
        else {
            fileSubject.onNext({ data: data, filePath: filePath });
        }
        fileSubject.onCompleted();
    });
    return fileSubject.asObservable();
}
function flattenDom(data) {
    var handler = new htmlparser.DefaultHandler(function (error, dom) { });
    var parser = new htmlparser.Parser(handler);
    parser.parseComplete(data);
    return traverseChildren(handler.dom);
}
function template(name, raw, sanitized, selector) {
    return "\n    /**\n     * " + raw.map(function (x) { return ("```" + x + "```"); }).join('\n') + "  \n     */\n    export const " + sanitized + " : \"" + selector + "\" = \"" + selector + "\";\n    ";
}
function generateViewModels(dom, filterRegex) {
    return dom.selectMany(function (_a) {
        var id = _a.id, context = _a.raw, classes = _a.classes;
        var models = ix_1.Enumerable.fromArray(classes)
            .select(function (selector) { return selector.trim(); })
            .where(function (selector) { return validSelectorRegex.test(selector) && filterRegex.test(selector); })
            .select(function (selector) { return ({
            name: "." + selector,
            context: context,
            sanitized: sanitizedSelector(selector),
            selector: "." + selector
        }); });
        if (id.length > 0 && validSelectorRegex.test(id.trim())) {
            return models.concat(ix_1.Enumerable.return({
                name: "\\#" + id,
                context: context,
                sanitized: sanitizedSelector(id) + "Id",
                selector: "#" + id
            }));
        }
        return models;
    });
}
function generateTemplate(models) {
    return models.groupBy(function (x) { return x.sanitized; })
        .select(function (x) {
        var contexts = x.select(function (x) { return x.context; });
        var first = x.first();
        var contextAndCounts = contexts
            .groupBy(function (x) { return x; })
            .select(function (x) { return (x.count() + "x <" + x.first() + ">"); });
        return template(first.name, contextAndCounts.toArray(), x.key, first.selector);
    });
}
/** Array.join implementation for enumerable */
function join(sequence, separator) {
    if (separator === void 0) { separator = ""; }
    return sequence.aggregate("", function (cumulus, x) { return cumulus.concat(x); });
}
function combineTemplate(name, selectors) {
    return "namespace TypeSheet." + name + " { " + join(selectors) + " }";
}
function replaceExtensionWithTs(filePath) {
    var baseName = path.basename(filePath, path.extname(filePath));
    return path.join(path.dirname(filePath), baseName + ".ts");
}
function writeFile(baseDir, filePath, typescript) {
    var subject = new Rx.Subject();
    var outputPath = path.join(baseDir, filePath);
    try {
        mkpath.sync(path.dirname(outputPath));
    }
    catch (error) {
        subject.onError(error);
    }
    fs.writeFile(outputPath, typescript, function (error) {
        if (error) {
            subject.onError(error);
        }
        else {
            subject.onNext(outputPath);
        }
        subject.onCompleted();
    });
    return subject.asObservable();
}
/** Replaces occurrences of dashes, dots and underscores separated words to *camelCase* */
function toCamalCase(str) {
    return str.replace(/[\-._]([a-zA-Z])/g, function (g) { return g[1].toUpperCase(); }).replace(/\-/g, '');
}
/**
 * Replace occurrences of any javascript keywords with the toUpperCase equivalent string
 */
function reservedToUpper(str) {
    return str.replace(reservedKeywordsRegex, function (g) { return g.toUpperCase(); });
}
function sanitizedSelector(selector) {
    return reservedToUpper(toCamalCase(selector));
}
function sanitizedNamespaceName(filePath) {
    return reservedToUpper(toCamalCase(path.basename(filePath, path.extname(filePath))));
}
function beginWatch(options) {
    watch(options._, options.init)
        .groupBy(function (filePath) { return filePath; })
        .flatMap(function (filePath) { return filePath
        .debounce(500)
        .flatMap(readFile)
        .map(function (_a) {
        var filePath = _a.filePath, data = _a.data;
        return ({ data: flattenDom(data), filePath: filePath });
    })
        .map(function (_a) {
        var filePath = _a.filePath, data = _a.data;
        return ({ data: generateViewModels(data, new RegExp(options.filterRegex)), filePath: filePath });
    })
        .distinctUntilChanged(function (x) { return x.data; }, function (x, y) { return ix_1.Enumerable.sequenceEqual(x, y); }); })
        .map(function (_a) {
        var filePath = _a.filePath, data = _a.data;
        return ({ data: generateTemplate(data), filePath: filePath });
    })
        .flatMap(function (_a) {
        var filePath = _a.filePath, data = _a.data;
        return writeFile(options.output, replaceExtensionWithTs(filePath), combineTemplate(sanitizedNamespaceName(filePath), data));
    })
        .subscribe(function next(path) {
        console.log("TypeSheet Ready: " + path);
    }, function error(error) {
        console.error(error);
    });
}
function main(args) {
    var options = minimist(args, {
        default: defaultOptions,
        boolean: ['init', 'help'],
        string: 'output',
        alias: {
            init: 'i',
            output: 'o',
            help: 'h',
            filterRegex: 'f',
        }
    });
    options._ = options._.length > 0 ? options._ : ["**/*.(cshtml|html)"];
    if (options.help) {
        console.log("\nTypeSheet Version: " + version + "\n\nusage: typesheet [options] [files or globs]\n\n    --init         -i   run initial pass on all matched files, default: false\n    --output       -o   output directory, default: 'Scripts/TypeSheet'\n    --filterRegex  -f   class name filter matches are kept , default: '^js' i.e. all classes starting with js\n    \n    [files or globs] files or glob pattern to watch, default : **/*.(cshtml|html)\n    \n    glob reference:\n    https://github.com/isaacs/node-glob");
        return;
    }
    console.log("Waiting for changes in: " + options._.join(' '));
    beginWatch(options);
}
main(process.argv.slice(2));
//# sourceMappingURL=typesheet.js.map at SyntaxError: Unexpected character '#' (1:78)
    at Parser.pp$4.raise (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2221:15)
    at Parser.pp$7.getTokenFromCode (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2756:10)
    at Parser.pp$7.readToken (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2477:17)
    at Parser.readToken (/root/ExpoSE/lib/Tropigate/bin/Tokens.js:124:26)
    at Parser.pp$7.nextToken (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2468:15)
    at Parser.pp$7.next (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2413:10)
    at Parser.pp.eat (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:536:12)
    at Parser.pp.semicolon (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:581:15)
    at Parser.pp$1.parseVarStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:918:10)
    at Parser.pp$1.parseStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:706:19)
*-- Replay with NO_COMPILE=1 expoSE replay '/root/ExpoSE/lib/Harness/src/harness.js' '{"_bound":0}'
*-- Coverage Data
*- File /root/ExpoSE/lib/Harness/src/harness.js. Coverage (Term): 18% Coverage (LOC): 24%
*- File /root/ExpoSE/lib/S$/bin/symbols.js. Coverage (Term): 16% Coverage (LOC): 34%
*- Re-run with EXPOSE_PRINT_COVERAGE=1 to print line by line coverage information
** ExpoSE Finished. 1 paths with 1 errors **
