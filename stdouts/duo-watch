/root/Targets/duo-watch
└─┬ duo-watch@0.1.1 
  ├─┬ debug@1.0.5 
  │ └── ms@2.0.0 
  ├─┬ minimatch@1.0.0 
  │ ├── lru-cache@2.7.3 
  │ └── sigmund@1.0.1 
  └─┬ sane@0.5.4 
    ├── minimatch@0.2.14 
    ├─┬ walker@1.0.7 
    │ └─┬ makeerror@1.0.11 
    │   └── tmpl@1.0.4 
    └── watch@0.10.0 

Setup Done exists, not setting up
:../FeatureTester/libs/:/root/Targets/duo-watch/node_modules
Set Default Z3_PATH to ./node_modules/z3javascript/bin/libz3.so
ExpoSE Master: /root/ExpoSE/lib/Harness/src/harness.js max concurrent: 16 max paths: 1000000
Setting timeout to 900000
*** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [0 done /0 queued / 1 running / 0 errors / 0% coverage ] ****** [1 done /0 queued / 0 running / 1 errors / 33% coverage ] ***
*-- Stat Module Output --*
*-- concretizations: ["defineProperty","bound log"]
*-- Stat Module Done --*
*-- Test Case {"_bound":0} start 0.0584 took 2.4206s
*-- Errors occured in test {"_bound":0}
* Error: Tropigate failed because SyntaxError: Unexpected token (6:4) on program /**
 * Module dependencies
 */

var debug = require('debug')('duo-watch');
var assert = require('assert');
var sane = require('sane');
var path = require('path');
var basename = path.basename;
var relative = path.relative;
var resolve = path.resolve;
var dirname = path.dirname;
var noop = function(){};
var fs = require('fs');
var join = path.join;

/**
 * Export `watch`
 */

module.exports = watch;

/**
 * Regexps
 */

var rslug = /([A-Za-z0-9-]{1,39})-([A-Za-z0-9-_\.]+)@([A-Za-z0-9-_\/\.$!#%&\(\)\+=]+)/i;

/**
 * Watching cache
 */

var watching = {};

/**
 * Initialize `watch`
 *
 * @param {String} root
 * @return {Watch}
 * @api public
 */

function watch(root) {
  if (watching[root]) return watching[root];
  return watching[root] = new Watch(root);
}

/**
 * Initialize `Watch`
 *
 * @param {String} root
 * @return {Watch}
 * @api private
 */

function Watch(root) {
  if (!(this instanceof Watch)) return new Watch(root);
  assert(root, 'must pass a "root" into watch');

  var self = this;

  this.path = join(root, 'components', 'duo.json');
  this.mapping = json(this.path);
  this.ready = false;
  this.root = root;
  this.fns = [];
  this.idx = {};

  // index entries
  this.index();

  // file watching
  this.sane = sane(root, Object.keys(this.idx))
    .on('change', this.change.bind(this))
    .on('ready', function() { self.ready = true });
}

/**
 * Get an array of dependencies
 *
 * @param {String} entry
 * @param {String} dep (optional)
 * @api private
 */

Watch.prototype.deps = function(entry, dep) {
  var mapping = this.mapping[dep || entry] || {};
  var deps = mapping.deps;
  var idx = this.idx;

  // add self
  if (!dep) idx[entry] = [entry];

  // add each dep
  for (dep in deps) {
    var file = deps[dep];
    if (!idx[file]) idx[file] = [];
    if (!~idx[file].indexOf(entry)) idx[file].push(entry);

    // add the manifest
    this.manifest(entry, file);

    // recurse
    this.deps(entry, file);
  }
};

/**
 * Build or rebuild the index.
 *
 * Watches files & manifests.
 *
 * {
 *   dep: [entry, ...],
 *   ...
 * }
 *
 * @param {String} file (optional)
 * @api private
 */

Watch.prototype.index = function(file) {
  var entries = entry
    ? this.idx[entry]
    : mains(this.mapping);

  for (var i = 0, entry; entry = entries[i++];) {
    entry == file
      ? this.deps(entry)
      : this.deps(entry, file);
  }

  return this;
};

/**
 * React to file changes
 *
 * @param {String} file
 * @api private
 */

Watch.prototype.change = function(file) {
  var entries = this.idx[file] || [];
  var fns = this.fns;
  var idx = this.idx;

  // logging
  debug('detected file change: %s', file);

  // call watch on all entries
  for (var i = 0, entry; entry = entries[i++];) {
    debug('triggering: %s', entry);

    // loop through all the functions
    for (var j = 0, fn; fn = fns[j++];) {
      fn(entry);
    }
  }

  // update mapping
  this.mapping = json(this.path);

  // re-index
  this.index(file);

  // logging
  debug('reindexed: %s. entries: %j', file, idx[file]);

  return this;
};

/**
 * Function to call when an entry
 * or it's deps change.
 *
 * @param {Function} fn
 * @return {Watch}
 * @api public
 */

Watch.prototype.watch = function(fn) {
  this.fns.push(fn || noop);
  return this;
};

/**
 * Stop file watching
 *
 * @return {Watch}
 * @api public
 */

Watch.prototype.close = function() {
  this.sane.close();
  return this;
};

/**
 * Paths to the manifest.
 * May or may not exist.
 *
 * @param {String} entry
 * @param {String} file
 */

Watch.prototype.manifest = function(entry, file) {
  var root = find(this.root, file);
  var manifest = join(root, 'component.json');
  var idx = this.idx;

  if (!idx[manifest]) idx[manifest] = [];
  if (!~idx[manifest].indexOf(entry)) idx[manifest].push(entry);

  return this;
};

/**
 * Read a JSON `path`
 *
 * @param {String} path
 * @return {Object}
 * @api private
 */

function json(path) {
  try {
    return JSON.parse(fs.readFileSync(path, 'utf8'));
  } catch (e) {
    return {};
  }
}

/**
 * Find the root
 *
 * @param {String} root
 * @param {String} path
 * @return {String} root
 */

function find(root, path) {

  while (path != '.' && path != root && !slug(path)) {
    path = dirname(path);
  }

  return path;

  function slug(path) {
    return rslug.test(basename(path));
  }
}

/**
 * Find the mains
 *
 * @param {Object} json
 * @return {Array} out
 * @api private
 */

function mains(json) {
  var out = [];

  for (var dep in json) {
    json[dep].entry && out.push(dep);
  }

  return out;
}
 at SyntaxError: Unexpected token (6:4)
    at Parser.pp$4.raise (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:2221:15)
    at Parser.pp.unexpected (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:603:10)
    at Parser.pp$2.parseBindingAtom (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1417:12)
    at Parser.parseBindingAtom (/root/ExpoSE/lib/Tropigate/bin/FunctionSignatures.js:49:30)
    at Parser.pp$1.parseVarId (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1049:20)
    at Parser.pp$1.parseVar (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:1032:14)
    at Parser.pp$1.parseVarStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:917:10)
    at Parser.pp$1.parseStatement (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:706:19)
    at Parser.parseStatement (/root/ExpoSE/lib/Tropigate/bin/Statements.js:104:30)
    at Parser.pp$1.parseTopLevel (/root/ExpoSE/lib/Tropigate/node_modules/acorn/dist/acorn.js:638:25)
*-- Replay with NO_COMPILE=1 expoSE replay '/root/ExpoSE/lib/Harness/src/harness.js' '{"_bound":0}'
*-- Coverage Data
*- File /root/ExpoSE/lib/Harness/src/harness.js. Coverage (Term): 18% Coverage (LOC): 24%
*- File /root/ExpoSE/lib/S$/bin/symbols.js. Coverage (Term): 16% Coverage (LOC): 34%
*- File /root/Targets/duo-watch/node_modules/duo-watch/index.js. Coverage (Term): 80% Coverage (LOC): 100%
*- Re-run with EXPOSE_PRINT_COVERAGE=1 to print line by line coverage information
** ExpoSE Finished. 1 paths with 1 errors **
