'use strict';

module.exports = function(options) {

  options = options || {};
  options.specialChar = '#';
  options.throwErrors = false;
  options.longTag = options.longTag ? options.longTag : true;
  options.nested = options.nested ? options.nested : true;
  options.comments = options.comments ? options.comments : false;
  options.parserInfos = options.parserInfos ? options.parserInfos : false;
  options.encoding = options.encoding ? options.encoding : 'utf8';

  return function (input, submit) {
    if (!input.content) {
      input.content = {};
    }
    var buffer = ''
      , readable = input.openStream();
    readable.setEncoding(options.encoding);
    readable.on('data', function(chunk) {
      buffer += chunk;
    });
    readable.on('error', function(err) {
      submit(err);
    });
    readable.on('end', function() {
      try {
        input.content['json'] = require('xml-mapping').load(buffer, options);
        submit(null, input);
      }
      catch (e) {
        submit(e);
      }
    });
  }

}
