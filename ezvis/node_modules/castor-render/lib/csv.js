/*jshint node:true, laxcomma:true*/
'use strict';
var path = require('path')
  , basename = path.basename(__filename, '.js')
  , debug = require('debug')('castor:render:' + basename)
  , util = require('util')
  , CSV = require('csv-string')
  , flatten = require('flat')
  , objectPath = require('object-path')
  ;

module.exports = function (input) {
  var render = function() {};

  render.pipe = function(output) {
    if (Array.isArray(input.data) && input.data[0]) {
      // CSV header
      var columns = input.parameters.columns.map(function (e) {return e.data; });
      var labels  = columns.map(function (c) {
        return input && input.config && input.config.documentFields && input.config.documentFields['$'+c] ?
          input.config.documentFields['$'+c].label || c :
          c;
      });
      output.write(CSV.stringify(labels));
      // CSV lines
      var lines = input.data.map(function (line) {
        var a = [];
        columns.forEach(function (column) {
          a.push(objectPath.get(line, column));
        });
        return a;
      });
      output.write(CSV.stringify(lines));
    }
    output.end();
  };

  return render;

};
